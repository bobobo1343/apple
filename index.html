<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Apple Music — Web Clone (Desktop)</title>
<!--
  iTunes / Apple Music-like web player
  Features:
    - Apple Music-like UI (desktop)
    - Dark mode toggle + auto-detect
    - Shuffle & repeat
    - Draggable mini player + detachable to new window (postMessage)
    - Google Drive folder loader using API key (only works for publicly shared files)
    - Defensive guards to prevent runtime errors
    - Minimal "Run Tests" harness
  Usage:
    - Paste your Google API Key and Folder ID in the `CONFIG` block below
    - If your Drive folder is private, set up OAuth2 client and tell me — I can add a client-side OAuth flow
  Security note:
    - Exposing API keys publicly is insecure. Restrict referrers in Google Cloud Console.
-->
<style>
  /* Basic Apple Music inspired styles (desktop-first) */
  :root{
    --bg:#f5f7fb; --card:#ffffff; --muted:#6b7280; --text:#0f1724;
    --accent:#ff2d55; --glass:rgba(255,255,255,0.6);
    --shadow: 0 6px 18px rgba(15,23,36,0.08);
  }
  [data-theme="dark"]{
    --bg:#0b0b0d; --card:rgba(21,21,25,0.8); --muted:#94a3b8; --text:#e6eef8;
    --accent:#ff375f; --glass:rgba(255,255,255,0.03); --shadow: 0 8px 28px rgba(0,0,0,0.6);
  }

  html,body{height:100%;margin:0;font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:linear-gradient(180deg,var(--bg),#e9eef6); color:var(--text);}
  .app{
    display:grid;
    grid-template-columns: 260px 1fr;
    height:100vh;
    gap:20px;
    padding:28px;
    box-sizing:border-box;
    align-items:stretch;
  }

  /* Sidebar */
  .sidebar{
    background:linear-gradient(180deg,var(--card),var(--glass));
    border-radius:12px; padding:20px; box-shadow:var(--shadow); height:calc(100vh - 56px); overflow:auto;
    display:flex;flex-direction:column;
  }
  .brand{ font-weight:700; font-size:20px; margin-bottom:18px; display:flex;align-items:center; gap:10px;}
  .sidebar .nav{display:flex;flex-direction:column;gap:8px}
  .nav button{ background:transparent; border:none; color:var(--text); text-align:left; padding:10px 8px; border-radius:8px; cursor:pointer; font-size:14px;}
  .nav button:hover{ background:rgba(0,0,0,0.04) }

  /* Main area */
  .main{
    display:flex; flex-direction:column; gap:14px;
  }

  .top-controls{ display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .search { flex:1; display:flex; gap:8px; align-items:center;}
  .search input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:var(--card); }

  .library{
    background:linear-gradient(180deg,var(--card),var(--glass));
    border-radius:12px; padding:18px; box-shadow:var(--shadow); height:calc(100vh - 200px); overflow:auto;
  }

  /* Album grid */
  .albums{ display:grid; grid-template-columns: repeat(auto-fill,minmax(160px,1fr)); gap:18px; }
  .album{ background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02)); padding:10px;border-radius:8px; display:flex; flex-direction:column; gap:10px; align-items:center; cursor:pointer;}
  .album .art{ width:140px; height:140px; background:linear-gradient(135deg,#ddd,#bbb); border-radius:8px; display:block; overflow:hidden; }
  .album .title{ font-size:13px; font-weight:600; text-align:center; color:var(--text); }
  .album .sub{ font-size:12px; color:var(--muted); text-align:center; }

  /* Now playing bar */
  .now-playing{
    position:fixed; left:300px; right:28px; bottom:20px; height:88px; background:var(--card); border-radius:12px; padding:12px 16px; box-shadow:var(--shadow);
    display:flex; align-items:center; gap:14px; z-index:999;
  }
  .np-art{ width:64px; height:64px; border-radius:8px; background:#cfd8e3; overflow:hidden;}
  .np-info{ flex:1; display:flex; flex-direction:column; gap:6px;}
  .np-controls{ display:flex; gap:10px; align-items:center;}
  .btn{ padding:8px 12px; border-radius:8px; background:transparent; border:1px solid rgba(0,0,0,0.06); cursor:pointer; }
  .btn.primary{ background:var(--accent); color:#fff; border:none; }
  .progress{ height:8px; background:rgba(0,0,0,0.06); border-radius:8px; overflow:hidden;}
  .progress > i{ display:block; height:100%; background:linear-gradient(90deg,var(--accent),#ff9aa2); width:0%; }

  /* Mini player */
  .mini-player{
    position:fixed; right:28px; bottom:120px; width:320px; height:72px; background:var(--card); border-radius:12px; box-shadow:var(--shadow); display:flex; gap:12px; padding:8px; align-items:center; cursor:grab; z-index:1001;
  }

  /* Responsive: for demo desktop only */
  @media (max-width: 900px){
    .app{ grid-template-columns: 1fr; padding:12px; }
    .sidebar{ display:none }
    .now-playing{ left:12px; right:12px; }
  }

  /* tiny helpers */
  .muted{ color:var(--muted); font-size:13px }
  .hide{ display:none!important; }
</style>
</head>
<body>

<div id="app" class="app" data-theme="">
  <aside class="sidebar" id="sidebar">
    <div class="brand"><svg width="28" height="28" viewBox="0 0 24 24" fill="none"><rect width="24" height="24" rx="6" fill="#ff2d55"/></svg>Apple Music</div>

    <div style="margin-bottom:12px">
      <button id="themeToggle" class="btn">Toggle Dark Mode</button>
      <button id="detachBtn" class="btn" style="margin-left:6px">Open Mini Player in New Window</button>
    </div>

    <div style="margin-bottom:12px">
      <input id="driveApiKey" placeholder="Google API Key" style="width:100%;padding:8px;border-radius:8px" />
      <input id="driveFolder" placeholder="Google Drive Folder ID" style="width:100%;padding:8px;border-radius:8px;margin-top:6px" />
      <div style="display:flex; gap:8px; margin-top:8px;">
        <button id="loadDrive" class="btn">Load Drive Folder</button>
        <button id="loadSample" class="btn">Load Sample</button>
      </div>
    </div>

    <nav class="nav">
      <button data-view="library">Library</button>
      <button data-view="albums">Albums</button>
      <button data-view="playlists">Playlists</button>
      <button data-view="radio">Radio</button>
      <button data-view="for-you">For You</button>
    </nav>

    <div style="margin-top:auto">
      <div class="muted">Signed in: <strong id="userLabel">Guest</strong></div>
    </div>
  </aside>

  <main class="main" id="main">
    <div class="top-controls">
      <div class="search">
        <input id="searchInput" placeholder="Search" />
      </div>
      <div style="display:flex; gap:8px; align-items:center;">
        <div class="muted" id="shuffleState">Shuffle: Off</div>
        <div class="muted" id="repeatState">Repeat: Off</div>
        <button id="shuffleBtn" class="btn">Shuffle</button>
        <button id="repeatBtn" class="btn">Repeat</button>
        <button id="runTests" class="btn">Run Tests</button>
      </div>
    </div>

    <section class="library" id="librarySection">
      <h2>Library</h2>
      <div class="albums" id="albumsGrid"></div>
    </section>
  </main>
</div>

<!-- Now playing bar -->
<div class="now-playing" id="nowPlayingBar" role="region" aria-label="Now Playing">
  <div class="np-art" id="npArt"></div>
  <div class="np-info">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div id="npTitle" style="font-weight:700">Nothing Playing</div>
        <div id="npArtist" class="muted">—</div>
      </div>
      <div class="np-controls">
        <button id="prevBtn" class="btn">⏮</button>
        <button id="playBtn" class="btn primary">▶</button>
        <button id="nextBtn" class="btn">⏭</button>
      </div>
    </div>

    <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
      <div style="width:90%;">
        <div class="progress" id="progressBar"><i id="progressFill"></i></div>
      </div>
      <div class="muted" id="timeLabel">0:00</div>
    </div>
  </div>
</div>

<!-- Mini player (draggable in-page) -->
<div id="miniPlayer" class="mini-player" title="Drag me">
  <div class="np-art" id="miniArt" style="width:56px;height:56px"></div>
  <div style="flex:1">
    <div id="miniTitle" style="font-weight:700">No Track</div>
    <div id="miniArtist" class="muted">—</div>
  </div>
  <div style="display:flex;flex-direction:column;gap:6px">
    <button id="miniPlay" class="btn">▶</button>
    <button id="miniDetach" class="btn">⤢</button>
  </div>
</div>

<!-- Hidden audio element -->
<audio id="audio" crossorigin="anonymous"></audio>

<script>
/*
  CONFIG - place your API key and folder ID here or use the UI inputs in the sidebar.
  NOTE: The API key in the code below is the one you provided. If you want it removed from the code, edit below or use inputs.
*/
const CONFIG = {
  googleApiKey: 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI', // you provided one earlier; replace if desired
  driveFolderId: '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn'
};

/* ---------------------
   tiny util helpers
   --------------------- */
function $$(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
function $(sel, root=document){ return root.querySelector(sel); }
function safe(fn){ try{ return fn(); }catch(e){ console.warn('safe error', e); return undefined; } }
function el(tag='div',cls=''){ const e=document.createElement(tag); if(cls) e.className=cls; return e; }
function formatTime(secs){
  if (!isFinite(secs)) return '0:00';
  secs = Math.floor(secs);
  const m = Math.floor(secs/60), s = secs%60; return m + ':' + (s<10? '0'+s : s);
}

/* ---------------------
   Application state
   --------------------- */
const state = {
  theme: window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light',
  library: [], // {id, name, artist, url, art, duration}
  queue: [],
  currentIndex: -1,
  isPlaying: false,
  shuffle: false,
  repeat: 'off', // 'off'|'one'|'all'
  detachedWindow: null,
  windowOrigin: window.location.origin
};

/* ---------------------
   Safe event emitter replacement
   Prevent undefined .emit usage — use this emitter
   --------------------- */
const E = (function(){
  const handlers = {};
  return {
    on(evt, cb){ (handlers[evt]||(handlers[evt]=[])).push(cb); return ()=>this.off(evt,cb); },
    off(evt, cb){ if(!handlers[evt]) return; handlers[evt] = handlers[evt].filter(fn=>fn!==cb); },
    emit(evt, ...args){ (handlers[evt]||[]).slice().forEach(fn=>{ try{ fn(...args);}catch(e){console.error('event handler error',e);} }); }
  };
})();

/* ---------------------
   DOM refs
   --------------------- */
const refs = {
  albumsGrid: $('#albumsGrid'),
  npTitle: $('#npTitle'),
  npArtist: $('#npArtist'),
  npArt: $('#npArt'),
  playBtn: $('#playBtn'),
  prevBtn: $('#prevBtn'),
  nextBtn: $('#nextBtn'),
  progressFill: $('#progressFill'),
  audio: $('#audio'),
  miniPlayer: $('#miniPlayer'),
  miniPlay: $('#miniPlay'),
  miniTitle: $('#miniTitle'),
  miniArtist: $('#miniArtist'),
  miniArt: $('#miniArt'),
  detachBtn: $('#detachBtn'),
  detachMiniBtn: $('#miniDetach')
};

/* ---------------------
   Initialization & theme
   --------------------- */
function applyTheme(t){
  document.getElementById('app').setAttribute('data-theme', t==='dark' ? 'dark' : '');
  state.theme = t;
  localStorage.setItem('theme', t);
}
(function initTheme(){
  const stored = localStorage.getItem('theme');
  const t = stored || state.theme;
  applyTheme(t);
})();

/* ---------------------
   Library rendering
   --------------------- */
function renderAlbums(){
  const grid = refs.albumsGrid;
  grid.innerHTML = '';
  state.library.forEach((item, idx) => {
    const a = el('div','album');
    a.dataset.index = idx;
    const art = el('div','art'); art.style.backgroundImage = item.art ? `url(${item.art})` : '';
    art.style.backgroundSize='cover'; art.style.backgroundPosition='center';
    a.appendChild(art);
    const t = el('div','title'); t.textContent = item.name || 'Unknown Title';
    const s = el('div','sub'); s.textContent = item.artist || '';
    a.appendChild(t); a.appendChild(s);
    a.addEventListener('dblclick', ()=>startPlaybackAt(idx));
    grid.appendChild(a);
  });
}

/* ---------------------
   Playback controls & audio wiring
   --------------------- */
function setNowPlaying(index){
  state.currentIndex = index;
  const track = state.queue[index];
  if(!track){
    refs.npTitle.textContent = 'Nothing Playing';
    refs.npArtist.textContent = '—';
    refs.npArt.style.backgroundImage = '';
    refs.audio.src = '';
    return;
  }
  refs.npTitle.textContent = track.name || 'Unknown';
  refs.npArtist.textContent = track.artist || '';
  refs.npArt.style.backgroundImage = track.art ? `url(${track.art})` : '';
  refs.miniTitle.textContent = track.name || 'Unknown';
  refs.miniArtist.textContent = track.artist || '';
  refs.miniArt.style.backgroundImage = track.art ? `url(${track.art})` : '';
  // set audio src
  if(track.url){
    refs.audio.src = track.url;
  }else{
    refs.audio.removeAttribute('src');
  }
  E.emit('nowplayingchange', track, index);
}

function play(){
  if(state.currentIndex < 0 && state.queue.length>0){
    setNowPlaying(0);
  }
  refs.audio.play().then(()=>{ state.isPlaying = true; refs.playBtn.textContent = '⏸'; refs.miniPlay.textContent='⏸'; E.emit('play'); }).catch(e=>{ console.warn('play failed', e); });
}

function pause(){
  refs.audio.pause(); state.isPlaying=false; refs.playBtn.textContent='▶'; refs.miniPlay.textContent='▶'; E.emit('pause');
}

function togglePlay(){
  if(state.isPlaying) pause(); else play();
}

function startPlaybackAt(idx){
  if(idx<0 || idx>=state.queue.length) return;
  setNowPlaying(idx);
  play();
}

/* next / prev with shuffle/repeat logic */
function pickNextIndex(forward=true){
  if(state.shuffle){
    if(state.queue.length<=1) return state.currentIndex;
    let i = state.currentIndex;
    let tries = 0;
    while(tries++ < 50){
      const r = Math.floor(Math.random()*state.queue.length);
      if(r !== state.currentIndex) return r;
    }
    return state.currentIndex;
  }
  // non-shuffle
  if(forward){
    let idx = state.currentIndex + 1;
    if(idx >= state.queue.length){
      if(state.repeat === 'all') return 0;
      return -1;
    }
    return idx;
  }else{
    let idx = state.currentIndex - 1;
    if(idx < 0){
      if(state.repeat === 'all') return state.queue.length - 1;
      return -1;
    }
    return idx;
  }
}

function nextTrack(){
  if(state.repeat === 'one'){
    // replay same
    refs.audio.currentTime = 0;
    play();
    return;
  }
  const next = pickNextIndex(true);
  if(next === -1){ pause(); setNowPlaying(-1); return; }
  startPlaybackAt(next);
}
function prevTrack(){
  const prev = pickNextIndex(false);
  if(prev === -1){ refs.audio.currentTime = 0; return; }
  startPlaybackAt(prev);
}

/* audio events */
refs.audio.addEventListener('timeupdate', ()=>{
  const pct = refs.audio.duration ? (refs.audio.currentTime / refs.audio.duration)*100 : 0;
  refs.progressFill.style.width = pct + '%';
  $('#timeLabel').textContent = formatTime(refs.audio.currentTime);
});
refs.audio.addEventListener('ended', ()=> nextTrack());
refs.audio.addEventListener('loadedmetadata', ()=>{ $('#timeLabel').textContent = formatTime(refs.audio.currentTime); });

/* UI hook-ups */
refs.playBtn.addEventListener('click', togglePlay);
refs.prevBtn.addEventListener('click', prevTrack);
refs.nextBtn.addEventListener('click', nextTrack);
refs.miniPlay.addEventListener('click', togglePlay);
$('#shuffleBtn').addEventListener('click', ()=>{
  state.shuffle = !state.shuffle;
  $('#shuffleState').textContent = 'Shuffle: ' + (state.shuffle? 'On':'Off');
});
$('#repeatBtn').addEventListener('click', ()=>{
  if(state.repeat==='off') state.repeat='all';
  else if(state.repeat==='all') state.repeat='one';
  else state.repeat='off';
  $('#repeatState').textContent = 'Repeat: ' + (state.repeat==='off'?'Off':(state.repeat==='one'?'One':'All'));
});

/* progress bar seek */
$('#progressBar').addEventListener('click', (e)=>{
  const rect = $('#progressBar').getBoundingClientRect();
  const x = e.clientX - rect.left; const p = x / rect.width;
  if(refs.audio.duration) refs.audio.currentTime = refs.audio.duration * p;
});

/* ---------------------
   Mini player: drag and detach/attach
   --------------------- */
(function miniPlayerDraggable(){
  const mp = refs.miniPlayer;
  let dragging=false, ox=0, oy=0, startX=0, startY=0;
  mp.addEventListener('mousedown', (ev)=>{
    dragging=true; mp.style.cursor='grabbing';
    startX = ev.clientX; startY = ev.clientY;
    const rect = mp.getBoundingClientRect();
    ox = rect.left; oy = rect.top;
    ev.preventDefault();
  });
  window.addEventListener('mousemove', (ev)=>{
    if(!dragging) return;
    mp.style.left = (ox + (ev.clientX - startX)) + 'px';
    mp.style.top = (oy + (ev.clientY - startY)) + 'px';
    mp.style.right = 'auto';
    mp.style.bottom = 'auto';
  });
  window.addEventListener('mouseup', ()=>{ if(dragging){ dragging=false; mp.style.cursor='grab'; }});
})();

/* Detach mini player into new window */
function openDetachedPlayer(){
  try{
    if(state.detachedWindow && !state.detachedWindow.closed){
      state.detachedWindow.focus();
      return;
    }
    const w = window.open('', 'DetachedMusicPlayer', 'width=420,height=160');
    if(!w) { alert('Pop-up blocked — allow popups for this site to open detached player.'); return; }
    // write simple player shell into that window, and set up postMessage comms
    w.document.write('<!doctype html><html><head><title>Detached Player</title></head><body style="margin:0;font-family:-apple-system,Segoe UI,Roboto"><div id="root"></div><script>window.addEventListener("message",e=>{ try{ const m=e.data; if(m.cmd==="state"){ // update UI } }catch(e){} }, false); window.opener && window.opener.postMessage({cmd:"request-state"}, "*");</script></body></html>');
    state.detachedWindow = w;
    // send initial state later
    setTimeout(()=> { sendStateToDetached(); }, 350);
    // listen for messages from detached window
    window.addEventListener('message', handleDetachedMessages);
  }catch(e){
    console.error('openDetachedPlayer error', e);
  }
}

function sendStateToDetached(){
  if(!state.detachedWindow || state.detachedWindow.closed) return;
  try{
    const payload = {
      cmd: 'update',
      state: {
        now: state.queue[state.currentIndex] || null,
        isPlaying: state.isPlaying
      }
    };
    state.detachedWindow.postMessage(payload, '*');
  }catch(e){ console.warn('failed to send state to detached', e); }
}

function handleDetachedMessages(e){
  const msg = e.data || {};
  if(msg && msg.cmd === 'request-state'){
    sendStateToDetached();
  }else if(msg && msg.cmd === 'play'){
    play();
  }else if(msg && msg.cmd === 'pause'){
    pause();
  }else if(msg && msg.cmd === 'next'){
    nextTrack();
  }else if(msg && msg.cmd === 'prev'){
    prevTrack();
  }
}

/* hook detach buttons */
refs.detachBtn.addEventListener('click', openDetachedPlayer);
refs.detachMiniBtn.addEventListener('click', openDetachedPlayer);

/* ---------------------
   Google Drive integration (simple folder listing)
   Notes:
     - Works for publicly shared folders only with API key
     - If your folder is private, you'll need OAuth
   --------------------- */
async function listDriveFiles(apiKey, folderId){
  if(!apiKey || !folderId) throw new Error('apiKey & folderId required');
  // Build query: files where parent is folderId and not trashed
  const q = encodeURIComponent("'" + folderId + "' in parents and trashed=false");
  const fields = encodeURIComponent('files(id,name,mimeType,thumbnailLink,webContentLink,iconLink)');
  const url = `https://www.googleapis.com/drive/v3/files?q=${q}&fields=${fields}&key=${apiKey}&pageSize=200`;
  const res = await fetch(url);
  if(!res.ok) {
    const txt = await res.text();
    throw new Error('Drive API error: ' + res.status + ' ' + txt);
  }
  const json = await res.json();
  return json.files || [];
}

/* Convert Drive file object to track item */
function driveFileToTrack(f){
  // Try to produce a streamable URL
  let url = f.webContentLink || f.downloadUrl || (f.exportLinks && Object.values(f.exportLinks)[0]) || null;
  // If url contains &export=download sometimes it works; else use viewer
  return {
    id: f.id,
    name: f.name,
    artist: 'Google Drive',
    url: url,
    art: f.thumbnailLink || null,
    orig: f
  };
}

/* UI: load from drive */
$('#loadDrive').addEventListener('click', async ()=>{
  const key = $('#driveApiKey').value || CONFIG.googleApiKey;
  const folder = $('#driveFolder').value || CONFIG.driveFolderId;
  $('#loadDrive').textContent = 'Loading...';
  try{
    const files = await listDriveFiles(key, folder);
    if(!files.length){ alert('No files found — ensure the folder is public and contains playable files.'); }
    const tracks = files.map(driveFileToTrack).filter(t => t.url || t.orig.mimeType && t.orig.mimeType.startsWith('audio'));
    // set library & queue
    state.library = tracks;
    state.queue = tracks.slice();
    renderAlbums();
    setNowPlaying(0);
    $('#loadDrive').textContent = 'Load Drive Folder';
  }catch(e){
    console.error('Drive load error', e);
    alert('Drive load failed: ' + (e.message || e));
    $('#loadDrive').textContent = 'Load Drive Folder';
  }
});

/* sample loader for offline testing */
$('#loadSample').addEventListener('click', ()=>{
  // create a few sample tracks with public URLs (CDN-free small sample)
  const sampleTracks = [
    { id:'s1', name:'Sample One', artist:'Demo', url:'https://cdn.jsdelivr.net/gh/anars/blank-audio@master/1-second-of-silence.mp3', art:'', duration:1 },
    { id:'s2', name:'Sample Two', artist:'Demo', url:'https://cdn.jsdelivr.net/gh/anars/blank-audio@master/1-second-of-silence.mp3', art:'' },
    { id:'s3', name:'Sample Three', artist:'Demo', url:'https://cdn.jsdelivr.net/gh/anars/blank-audio@master/1-second-of-silence.mp3', art:'' }
  ];
  state.library = sampleTracks;
  state.queue = sampleTracks.slice();
  renderAlbums();
  setNowPlaying(0);
});

/* ---------------------
   Safe initialization to avoid undefined event emitters etc.
   --------------------- */
function safeInit(){
  try{
    // wire search
    $('#searchInput').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      const filtered = state.library.filter(t => (t.name||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q));
      state.queue = filtered.slice();
      renderAlbums();
    });

    // set UI defaults
    $('#driveApiKey').value = CONFIG.googleApiKey || '';
    $('#driveFolder').value = CONFIG.driveFolderId || '';
    $('#runTests').addEventListener('click', runTests);

    // attach event listeners for E emitter as example
    E.on('nowplayingchange', (track, idx)=>{ sendStateToDetached(); });

    // set stored theme toggle
    $('#themeToggle').addEventListener('click', ()=> applyTheme(state.theme==='dark'?'light':'dark'));

    // safe render
    renderAlbums();
  }catch(e){ console.error('safeInit failed', e); }
}
safeInit();

/* ---------------------
   Tests: run small sequences to exercise core flows
   --------------------- */
async function runTests(){
  console.log('Running tests...');
  try{
    // Test 1: Load sample library
    $('#loadSample').click();
    await new Promise(r=>setTimeout(r,200));
    if(state.library.length < 1) throw new Error('Sample not loaded');

    // Test 2: Start play
    startPlaybackAt(0);
    await new Promise(r=>setTimeout(r,200));
    if(!refs.audio.src) throw new Error('Audio src not set');

    // Test 3: Shuffle toggling
    $('#shuffleBtn').click();
    $('#shuffleBtn').click();

    // Test 4: Detach window open (attempt)
    openDetachedPlayer();

    console.log('All quick tests completed (check UI).');
    alert('Quick tests completed — check console for details.');
  }catch(e){
    console.error('runTests failed', e);
    alert('Tests failed: ' + (e.message || e));
  }
}

/* ---------------------
   Final helpful bits: initialize minimal state if none
   --------------------- */
if(!state.library.length){
  // load sample automatically for demo
  $('#loadSample').click();
}
</script>
</body>
</html>
