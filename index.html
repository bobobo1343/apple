<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>iTunes Clone Web Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Reset & basic */
    * {
      box-sizing: border-box;
    }
    body, html {
      margin: 0; padding: 0; height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #f5f5f7;
      color: #1d1d1f;
      overflow: hidden;
      user-select: none;
    }
    a {
      color: inherit;
      text-decoration: none;
    }
    /* Container */
    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
    }
    /* Sidebar (Library, Playlists) */
    #sidebar {
      width: 260px;
      background-color: #f0f0f2;
      border-right: 1px solid #c8c7cc;
      display: flex;
      flex-direction: column;
    }
    #sidebar header {
      padding: 16px;
      font-weight: 700;
      font-size: 24px;
      border-bottom: 1px solid #c8c7cc;
      user-select: none;
    }
    #sidebar nav {
      flex: 1;
      overflow-y: auto;
    }
    #sidebar nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #sidebar nav li {
      padding: 12px 20px;
      cursor: pointer;
      border-bottom: 1px solid #d1d1d6;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background-color 0.15s ease;
    }
    #sidebar nav li:hover,
    #sidebar nav li.active {
      background-color: #007aff;
      color: white;
    }
    #sidebar nav li svg {
      width: 18px; height: 18px;
      fill: currentColor;
      flex-shrink: 0;
    }
    /* Main content (Music Library / Playlists / Now Playing) */
    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    /* Header with search and dropdowns */
    #main-header {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid #c8c7cc;
      background: white;
      user-select: none;
      gap: 20px;
    }
    #main-header h2 {
      margin: 0;
      font-weight: 600;
      font-size: 20px;
    }
    #search-container {
      flex: 1;
      position: relative;
    }
    #search-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #c8c7cc;
      border-radius: 8px;
      font-size: 16px;
      outline: none;
      transition: border-color 0.15s ease;
    }
    #search-input:focus {
      border-color: #007aff;
    }
    /* Music list table */
    #music-list {
      flex: 1;
      overflow-y: auto;
      background: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    thead {
      background-color: #f7f7f8;
      user-select: none;
    }
    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #e3e3e8;
    }
    th {
      font-weight: 600;
      color: #6e6e73;
    }
    tr:hover {
      background-color: #e5e5ea;
      cursor: pointer;
    }
    tr.playing {
      background-color: #007aff;
      color: white;
    }
    /* Now Playing bar */
    #now-playing-bar {
      height: 96px;
      background: #f0f0f2;
      border-top: 1px solid #c8c7cc;
      display: flex;
      align-items: center;
      padding: 10px 20px;
      gap: 20px;
      user-select: none;
    }
    #now-playing-bar img {
      width: 64px;
      height: 64px;
      border-radius: 6px;
      object-fit: cover;
      background: #ddd;
      flex-shrink: 0;
    }
    #track-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      overflow: hidden;
    }
    #track-info .title {
      font-weight: 700;
      font-size: 18px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #track-info .artist {
      font-size: 14px;
      color: #6e6e73;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    #playback-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    button.control-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: #007aff;
      padding: 8px;
      border-radius: 50%;
      transition: background-color 0.2s ease;
    }
    button.control-btn:hover {
      background-color: #007aff22;
    }
    #progress-container {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 0 20px;
      user-select: none;
    }
    #progress-bar {
      flex: 1;
      height: 6px;
      background: #ccc;
      border-radius: 3px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }
    #progress-filled {
      height: 100%;
      background: #007aff;
      width: 0%;
      transition: width 0.1s linear;
    }
    #time-current,
    #time-duration {
      font-size: 12px;
      color: #6e6e73;
      min-width: 35px;
      text-align: center;
      user-select: none;
    }
    /* Volume and EQ */
    #volume-container {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 140px;
      user-select: none;
    }
    #volume-slider {
      width: 100px;
    }
    /* Equalizer modal */
    #eq-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      width: 400px;
      padding: 20px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      transform: translate(-50%, -50%);
      display: none;
      flex-direction: column;
      z-index: 1000;
    }
    #eq-modal h3 {
      margin: 0 0 12px 0;
      font-weight: 700;
      text-align: center;
    }
    #eq-sliders {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      height: 160px;
      margin-bottom: 12px;
    }
    .eq-band {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      flex: 1;
    }
    .eq-band label {
      font-size: 12px;
      user-select: none;
    }
    .eq-band input[type="range"] {
      writing-mode: bt-lr; /* vertical slider */
      -webkit-appearance: slider-vertical;
      width: 120px;
      height: 24px;
      margin: 0;
      transform: rotate(270deg);
    }
    #eq-close-btn {
      align-self: center;
      padding: 6px 20px;
      background: #007aff;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.15s ease;
    }
    #eq-close-btn:hover {
      background: #005ecb;
    }
    /* Overlay */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.25);
      display: none;
      z-index: 900;
    }
    /* Scrollbars for sidebar and music list */
    #sidebar nav::-webkit-scrollbar,
    #music-list::-webkit-scrollbar {
      width: 8px;
    }
    #sidebar nav::-webkit-scrollbar-thumb,
    #music-list::-webkit-scrollbar-thumb {
      background-color: #c8c7cc;
      border-radius: 4px;
    }
    /* Dropdown menus */
    .dropdown {
      position: relative;
      user-select: none;
    }
    .dropdown-toggle {
      cursor: pointer;
      padding: 6px 12px;
      border: 1px solid #c8c7cc;
      border-radius: 6px;
      background: white;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color 0.15s ease;
    }
    .dropdown-toggle:hover,
    .dropdown-toggle.active {
      border-color: #007aff;
      color: #007aff;
    }
    .dropdown-menu {
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border: 1px solid #c8c7cc;
      border-radius: 6px;
      margin-top: 6px;
      min-width: 160px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 500;
      display: none;
      user-select: none;
    }
    .dropdown-menu.show {
      display: block;
    }
    .dropdown-menu li {
      list-style: none;
      padding: 8px 14px;
      cursor: pointer;
      transition: background-color 0.15s ease;
    }
    .dropdown-menu li:hover {
      background-color: #007aff22;
    }
    /* Scrollable dropdown menus */
    .dropdown-menu.scrollable {
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>

<div id="app">
  <aside id="sidebar">
    <header>iTunes</header>
    <nav>
      <ul id="library-menu">
        <li class="active" data-section="library">
          <svg viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h12v2H3z"/></svg>
          Library
        </li>
        <li data-section="playlists" id="playlists-tab">
          <svg viewBox="0 0 24 24"><path d="M3 5h14v2H3zm0 4h10v2H3zm0 4h14v2H3zm0 4h10v2H3z"/></svg>
          Playlists
        </li>
        <li id="eq-btn">
          <svg viewBox="0 0 24 24"><path d="M3 17h2v-4H3zm6-10h2v14h-2zm6 6h2v8h-2zm6-10h2v18h-2z"/></svg>
          Equalizer
        </li>
      </ul>
    </nav>
  </aside>

  <main id="main">
    <div id="main-header">
      <h2 id="section-title">Library</h2>
      <div id="search-container">
        <input type="search" id="search-input" placeholder="Search music..." aria-label="Search music" />
      </div>
      <div class="dropdown" id="sort-dropdown">
        <div class="dropdown-toggle" tabindex="0" aria-haspopup="true" aria-expanded="false" aria-label="Sort Options">
          Sort By <span id="sort-selected">Title</span> ▼
        </div>
        <ul class="dropdown-menu" role="menu" aria-label="Sort options">
          <li data-sort="title" role="menuitem">Title</li>
          <li data-sort="artist" role="menuitem">Artist</li>
          <li data-sort="album" role="menuitem">Album</li>
          <li data-sort="duration" role="menuitem">Duration</li>
        </ul>
      </div>
    </div>

    <section id="music-list">
      <table role="grid" aria-label="Music list">
        <thead>
          <tr>
            <th>Title</th>
            <th>Artist</th>
            <th>Album</th>
            <th>Duration</th>
          </tr>
        </thead>
        <tbody id="tracks-tbody">
          <!-- Tracks dynamically inserted here -->
        </tbody>
      </table>
    </section>

    <section id="now-playing-bar" aria-label="Now Playing Bar">
      <img id="now-playing-artwork" alt="Album artwork" src="" />
      <div id="track-info">
        <div class="title" id="now-playing-title">Not Playing</div>
        <div class="artist" id="now-playing-artist"></div>
      </div>
      <div id="playback-controls">
        <button class="control-btn" id="btn-prev" aria-label="Previous Track">⏮️</button>
        <button class="control-btn" id="btn-play" aria-label="Play/Pause">▶️</button>
        <button class="control-btn" id="btn-next" aria-label="Next Track">⏭️</button>
        <button class="control-btn" id="btn-shuffle" aria-label="Shuffle">🔀</button>
        <button class="control-btn" id="btn-repeat" aria-label="Repeat">🔁</button>
      </div>
      <div id="progress-container">
        <span id="time-current">0:00</span>
        <div id="progress-bar" tabindex="0" role="slider" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-label="Seek Bar">
          <div id="progress-filled"></div>
        </div>
        <span id="time-duration">0:00</span>
      </div>
      <div id="volume-container" title="Volume Control">
        🔈
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" aria-label="Volume" />
      </div>
    </section>
  </main>
</div>

<!-- Equalizer Modal -->
<div id="eq-modal" role="dialog" aria-modal="true" aria-labelledby="eq-title">
  <h3 id="eq-title">Equalizer</h3>
  <div id="eq-sliders">
    <!-- Bands sliders inserted dynamically -->
  </div>
  <button id="eq-close-btn">Close</button>
</div>
<div id="overlay"></div>

<script>
  // Configuration for your Google Drive folder and API key
  const GOOGLE_API_KEY = 'AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI';
  const FOLDER_ID = '1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn';

  // App state
  let musicLibrary = [];
  let filteredLibrary = [];
  let currentTrackIndex = -1;
  let isPlaying = false;
  let shuffleMode = false;
  let repeatMode = 'off'; // off, one, all

  // Audio and Web Audio API setup
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const audioElement = new Audio();
  const trackSource = audioCtx.createMediaElementSource(audioElement);

  // Create EQ filters - 5 band graphic eq
  const eqFrequencies = [60, 170, 350, 1000, 3500, 10000];
  const eqFilters = eqFrequencies.map(freq => {
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'peaking';
    filter.frequency.value = freq;
    filter.Q.value = 1;
    filter.gain.value = 0; // Default flat
    return filter;
  });
  // Connect filters in series
  trackSource.connect(eqFilters[0]);
  for (let i = 0; i < eqFilters.length - 1; i++) {
    eqFilters[i].connect(eqFilters[i + 1]);
  }
  eqFilters[eqFilters.length - 1].connect(audioCtx.destination);

  // Elements references
  const tracksTbody = document.getElementById('tracks-tbody');
  const nowPlayingTitle = document.getElementById('now-playing-title');
  const nowPlayingArtist = document.getElementById('now-playing-artist');
  const nowPlayingArtwork = document.getElementById('now-playing-artwork');
  const btnPlay = document.getElementById('btn-play');
  const btnPrev = document.getElementById('btn-prev');
  const btnNext = document.getElementById('btn-next');
  const btnShuffle = document.getElementById('btn-shuffle');
  const btnRepeat = document.getElementById('btn-repeat');
  const progressBar = document.getElementById('progress-bar');
  const progressFilled = document.getElementById('progress-filled');
  const timeCurrent = document.getElementById('time-current');
  const timeDuration = document.getElementById('time-duration');
  const volumeSlider = document.getElementById('volume-slider');
  const searchInput = document.getElementById('search-input');
  const sectionTitle = document.getElementById('section-title');
  const eqBtn = document.getElementById('eq-btn');
  const eqModal = document.getElementById('eq-modal');
  const overlay = document.getElementById('overlay');
  const eqSlidersContainer = document.getElementById('eq-sliders');
  const eqCloseBtn = document.getElementById('eq-close-btn');
  const sidebarItems = document.querySelectorAll('#sidebar nav li');
  const sortDropdown = document.getElementById('sort-dropdown');
  const sortToggle = sortDropdown.querySelector('.dropdown-toggle');
  const sortMenu = sortDropdown.querySelector('.dropdown-menu');
  const sortSelected = document.getElementById('sort-selected');

  // Volume defaults
  audioElement.volume = 0.5;
  volumeSlider.value = 0.5;

  // Helper: Format seconds as mm:ss
  function formatTime(sec) {
    const minutes = Math.floor(sec / 60) || 0;
    const seconds = Math.floor(sec % 60) || 0;
    return `${minutes}:${seconds.toString().padStart(2, '0')}`;
  }

  // Fetch files from Google Drive folder
  async function fetchMusicFiles() {
    // Files endpoint: https://www.googleapis.com/drive/v3/files
    // We want only audio mime types in this folder
    const url = `https://www.googleapis.com/drive/v3/files?q='${FOLDER_ID}'+in+parents+and+mimeType+contains+'audio/'&key=${GOOGLE_API_KEY}&fields=files(id,name,mimeType,thumbnailLink,videoMediaMetadata)`;
    try {
      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch files from Google Drive');
      const data = await res.json();

      // Parse files
      musicLibrary = data.files.map(file => {
        // Extract title and extension
        const name = file.name;
        const title = name.replace(/\.[^/.]+$/, "");
        // Google Drive direct download URL
        const streamUrl = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media&key=${GOOGLE_API_KEY}`;

        return {
          id: file.id,
          title: title,
          artist: 'Unknown Artist', // Google Drive has no metadata; could parse tags in future
          album: 'Unknown Album',
          duration: 0, // will update later
          artwork: file.thumbnailLink || '',
          streamUrl: streamUrl,
          mimeType: file.mimeType,
        };
      });
      filteredLibrary = [...musicLibrary];
      await preloadDurations();
      renderTrackList();
    } catch (e) {
      alert('Error loading music files: ' + e.message);
    }
  }

  // Preload durations by loading audio metadata silently
  async function preloadDurations() {
    for (const track of musicLibrary) {
      try {
        await new Promise(resolve => {
          const tempAudio = new Audio();
          tempAudio.src = track.streamUrl;
          tempAudio.preload = "metadata";
          tempAudio.addEventListener('loadedmetadata', () => {
            track.duration = tempAudio.duration;
            resolve();
          });
          tempAudio.addEventListener('error', () => {
            track.duration = 0;
            resolve();
          });
        });
      } catch {
        track.duration = 0;
      }
    }
  }

  // Render music list table
  function renderTrackList() {
    tracksTbody.innerHTML = '';
    filteredLibrary.forEach((track, i) => {
      const tr = document.createElement('tr');
      tr.setAttribute('data-index', i);
      tr.setAttribute('tabindex', 0);
      if (i === currentTrackIndex) tr.classList.add('playing');

      tr.innerHTML = `
        <td>${track.title}</td>
        <td>${track.artist}</td>
        <td>${track.album}</td>
        <td>${track.duration ? formatTime(track.duration) : '--:--'}</td>
      `;
      // Click to play
      tr.addEventListener('click', () => {
        playTrack(i);
      });
      tr.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          playTrack(i);
        }
      });
      tracksTbody.appendChild(tr);
    });
  }

  // Play track by index
  function playTrack(index) {
    if (index < 0 || index >= filteredLibrary.length) return;
    currentTrackIndex = index;
    const track = filteredLibrary[index];
    if (!track) return;

    if (audioCtx.state === 'suspended') {
      audioCtx.resume();
    }

    audioElement.src = track.streamUrl;
    audioElement.play().then(() => {
      isPlaying = true;
      updateNowPlaying();
      updateTrackListHighlight();
      updatePlayPauseBtn();
    }).catch(console.error);
  }

  // Update Now Playing display
  function updateNowPlaying() {
    if (currentTrackIndex < 0 || currentTrackIndex >= filteredLibrary.length) {
      nowPlayingTitle.textContent = 'Not Playing';
      nowPlayingArtist.textContent = '';
      nowPlayingArtwork.src = '';
      return;
    }
    const track = filteredLibrary[currentTrackIndex];
    nowPlayingTitle.textContent = track.title;
    nowPlayingArtist.textContent = track.artist;
    nowPlayingArtwork.src = track.artwork || 'https://upload.wikimedia.org/wikipedia/commons/2/29/Apple_logo_black.svg';
  }

  // Update track list row highlight
  function updateTrackListHighlight() {
    [...tracksTbody.children].forEach((tr, i) => {
      tr.classList.toggle('playing', i === currentTrackIndex);
    });
  }

  // Play/Pause toggle
  function togglePlayPause() {
    if (isPlaying) {
      audioElement.pause();
      isPlaying = false;
    } else {
      audioElement.play().catch(console.error);
      isPlaying = true;
    }
    updatePlayPauseBtn();
  }
  function updatePlayPauseBtn() {
    btnPlay.textContent = isPlaying ? '⏸️' : '▶️';
  }

  // Play next track (consider shuffle/repeat)
  function playNext() {
    if (shuffleMode) {
      const nextIndex = Math.floor(Math.random() * filteredLibrary.length);
      playTrack(nextIndex);
      return;
    }
    let nextIndex = currentTrackIndex + 1;
    if (nextIndex >= filteredLibrary.length) {
      if (repeatMode === 'all') {
        nextIndex = 0;
      } else {
        // Stop playing
        audioElement.pause();
        isPlaying = false;
        updatePlayPauseBtn();
        return;
      }
    }
    playTrack(nextIndex);
  }

  // Play previous track
  function playPrev() {
    let prevIndex = currentTrackIndex - 1;
    if (prevIndex < 0) {
      if (repeatMode === 'all') {
        prevIndex = filteredLibrary.length - 1;
      } else {
        // Restart current track
        audioElement.currentTime = 0;
        return;
      }
    }
    playTrack(prevIndex);
  }

  // Shuffle toggle
  function toggleShuffle() {
    shuffleMode = !shuffleMode;
    btnShuffle.style.color = shuffleMode ? '#007aff' : '#666';
  }

  // Repeat toggle (off → all → one → off)
  function toggleRepeat() {
    if (repeatMode === 'off') {
      repeatMode = 'all';
      btnRepeat.style.color = '#007aff';
      btnRepeat.textContent = '🔁';
    } else if (repeatMode === 'all') {
      repeatMode = 'one';
      btnRepeat.style.color = '#007aff';
      btnRepeat.textContent = '🔂';
    } else {
      repeatMode = 'off';
      btnRepeat.style.color = '#666';
      btnRepeat.textContent = '🔁';
    }
  }

  // Progress bar update
  audioElement.addEventListener('timeupdate', () => {
    if (!audioElement.duration) return;
    const percent = (audioElement.currentTime / audioElement.duration) * 100;
    progressFilled.style.width = percent + '%';
    timeCurrent.textContent = formatTime(audioElement.currentTime);
    timeDuration.textContent = formatTime(audioElement.duration);
    progressBar.setAttribute('aria-valuenow', Math.floor(percent));
  });

  // Seek on progress bar click
  progressBar.addEventListener('click', e => {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const percent = clickX / rect.width;
    if (audioElement.duration) {
      audioElement.currentTime = audioElement.duration * percent;
    }
  });
  progressBar.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
      e.preventDefault();
      audioElement.currentTime = Math.max(0, audioElement.currentTime - 5);
    } else if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
      e.preventDefault();
      audioElement.currentTime = Math.min(audioElement.duration, audioElement.currentTime + 5);
    }
  });

  // Volume slider
  volumeSlider.addEventListener('input', () => {
    audioElement.volume = volumeSlider.value;
  });

  // Search input
  searchInput.addEventListener('input', () => {
    const query = searchInput.value.toLowerCase();
    filteredLibrary = musicLibrary.filter(track => {
      return (
        track.title.toLowerCase().includes(query) ||
        track.artist.toLowerCase().includes(query) ||
        track.album.toLowerCase().includes(query)
      );
    });
    renderTrackList();
  });

  // Sort dropdown functionality
  sortToggle.addEventListener('click', () => {
    sortMenu.classList.toggle('show');
  });
  // Close dropdown clicking outside
  document.addEventListener('click', (e) => {
    if (!sortDropdown.contains(e.target)) {
      sortMenu.classList.remove('show');
    }
  });
  sortMenu.querySelectorAll('li').forEach(li => {
    li.addEventListener('click', () => {
      const sortKey = li.dataset.sort;
      sortSelected.textContent = li.textContent;
      sortMenu.classList.remove('show');
      sortLibrary(sortKey);
    });
  });

  function sortLibrary(key) {
    filteredLibrary.sort((a, b) => {
      if (key === 'duration') return (a.duration || 0) - (b.duration || 0);
      return a[key].localeCompare(b[key]);
    });
    renderTrackList();
  }

  // Sidebar tab switching (Library and Playlists - playlists not implemented yet)
  sidebarItems.forEach(item => {
    item.addEventListener('click', () => {
      sidebarItems.forEach(i => i.classList.remove('active'));
      item.classList.add('active');
      const section = item.dataset.section || '';
      if (section === 'library') {
        sectionTitle.textContent = 'Library';
        // TODO: switch to library view
      } else if (section === 'playlists') {
        sectionTitle.textContent = 'Playlists';
        // TODO: implement playlists
        alert('Playlists coming soon!');
      } else if (item.id === 'eq-btn') {
        openEQModal();
      }
    });
  });

  // EQ modal
  const eqBands = [
    { freq: 60, label: "60 Hz" },
    { freq: 170, label: "170 Hz" },
    { freq: 350, label: "350 Hz" },
    { freq: 1000, label: "1 kHz" },
    { freq: 3500, label: "3.5 kHz" },
    { freq: 10000, label: "10 kHz" },
  ];

  function openEQModal() {
    eqSlidersContainer.innerHTML = '';
    eqBands.forEach((band, idx) => {
      const div = document.createElement('div');
      div.classList.add('eq-band');
      div.innerHTML = `
        <label for="eq-band-${idx}">${band.label}</label>
        <input type="range" id="eq-band-${idx}" min="-12" max="12" step="0.5" value="${eqFilters[idx].gain.value}" />
      `;
      eqSlidersContainer.appendChild(div);

      const slider = div.querySelector('input');
      slider.addEventListener('input', (e) => {
        eqFilters[idx].gain.value = parseFloat(e.target.value);
      });
    });
    eqModal.style.display = 'flex';
    overlay.style.display = 'block';
  }
  eqCloseBtn.addEventListener('click', closeEQModal);
  overlay.addEventListener('click', closeEQModal);

  function closeEQModal() {
    eqModal.style.display = 'none';
    overlay.style.display = 'none';
  }

  // Playback controls buttons
  btnPlay.addEventListener('click', togglePlayPause);
  btnPrev.addEventListener('click', playPrev);
  btnNext.addEventListener('click', playNext);
  btnShuffle.addEventListener('click', toggleShuffle);
  btnRepeat.addEventListener('click', toggleRepeat);

  // Auto play next track when current ends
  audioElement.addEventListener('ended', () => {
    if (repeatMode === 'one') {
      playTrack(currentTrackIndex);
    } else {
      playNext();
    }
  });

  // Initialize
  async function init() {
    await fetchMusicFiles();
    updatePlayPauseBtn();
    btnShuffle.style.color = '#666';
    btnRepeat.style.color = '#666';
  }
  init();

</script>
</body>
</html>
