<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>iTunes Web Clone</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
    user-select: none;
  }
  body,html {
    margin:0; padding:0; height:100vh; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
      Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    background: #f7f7f7;
    color: #333;
    display: flex;
    flex-direction: column;
  }
  /* Top Menu Bar */
  #top-menu {
    background: #e6e6e6;
    border-bottom: 1px solid #ccc;
    padding: 4px 12px;
    display: flex;
    align-items: center;
    font-size: 13px;
    user-select:none;
  }
  #top-menu > ul {
    list-style: none;
    display: flex;
    margin: 0; padding: 0;
  }
  #top-menu > ul > li {
    position: relative;
    padding: 0 12px;
    cursor: pointer;
    line-height: 24px;
  }
  #top-menu > ul > li:hover {
    background: #d1d1d1;
  }
  /* Dropdown */
  #top-menu > ul > li > ul {
    position: absolute;
    top: 24px;
    left: 0;
    background: white;
    border: 1px solid #ccc;
    padding: 4px 0;
    display: none;
    min-width: 140px;
    z-index: 1000;
    box-shadow: 0 3px 6px rgba(0,0,0,0.15);
  }
  #top-menu > ul > li:hover > ul {
    display: block;
  }
  #top-menu > ul > li > ul > li {
    padding: 6px 12px;
    font-size: 13px;
  }
  #top-menu > ul > li > ul > li:hover {
    background: #007aff;
    color: white;
  }

  /* Main container */
  #main {
    flex: 1;
    display: flex;
    height: calc(100vh - 30px);
    overflow: hidden;
  }
  /* Sidebar */
  #sidebar {
    width: 200px;
    background: #ededed;
    border-right: 1px solid #ccc;
    display: flex;
    flex-direction: column;
  }
  #sidebar h2 {
    margin: 12px;
    font-size: 16px;
    color: #666;
    user-select:none;
  }
  #sidebar ul {
    list-style: none;
    margin: 0; padding: 0;
    flex: 1;
    overflow-y: auto;
  }
  #sidebar ul li {
    padding: 8px 16px;
    cursor: pointer;
    font-size: 14px;
    color: #333;
    border-left: 3px solid transparent;
  }
  #sidebar ul li:hover {
    background: #d8d8d8;
  }
  #sidebar ul li.active {
    background: white;
    font-weight: 600;
    border-left-color: #007aff;
    color: #007aff;
  }

  /* Content Area */
  #content {
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  /* Toolbar above track list */
  #toolbar {
    height: 40px;
    background: #f3f3f3;
    border-bottom: 1px solid #ccc;
    padding: 4px 12px;
    display: flex;
    align-items: center;
  }
  #toolbar input[type="text"] {
    flex: 1;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 14px;
    padding: 6px 8px;
  }
  #toolbar select {
    margin-left: 12px;
    font-size: 14px;
    padding: 4px 6px;
  }
  #toolbar button {
    margin-left: 12px;
    background: #007aff;
    border: none;
    border-radius: 4px;
    color: white;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 14px;
  }
  #toolbar button:hover {
    background: #005ecb;
  }

  /* Track list */
  #tracklist-container {
    flex: 1;
    overflow-y: auto;
  }
  table#tracklist {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
  }
  #tracklist thead {
    background: #f0f0f0;
    user-select:none;
  }
  #tracklist thead tr th {
    padding: 8px 12px;
    border-bottom: 1px solid #ccc;
    cursor: pointer;
    text-align: left;
    position: relative;
  }
  #tracklist thead tr th:hover {
    background: #e2e2e2;
  }
  #tracklist tbody tr {
    cursor: pointer;
  }
  #tracklist tbody tr:nth-child(odd) {
    background: white;
  }
  #tracklist tbody tr:nth-child(even) {
    background: #fafafa;
  }
  #tracklist tbody tr:hover {
    background: #d8eaff;
  }
  #tracklist tbody tr.playing {
    background: #007aff;
    color: white;
    font-weight: 600;
  }
  #tracklist tbody tr.playing:hover {
    background: #005ecb;
  }
  #tracklist tbody tr td {
    padding: 8px 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* Now Playing Bar */
  #now-playing-bar {
    height: 60px;
    background: #f3f3f3;
    border-top: 1px solid #ccc;
    display: flex;
    align-items: center;
    padding: 0 12px;
    user-select:none;
  }
  #now-playing-info {
    flex: 1;
    font-size: 14px;
    color: #333;
  }
  #now-playing-info .title {
    font-weight: 600;
  }
  #now-playing-controls {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  #now-playing-controls button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 20px;
    color: #007aff;
    user-select:none;
  }
  #now-playing-controls button:focus {
    outline: 2px solid #007aff;
    outline-offset: 2px;
  }
  #progress-container {
    flex: 3;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #progress-bar {
    flex: 1;
    height: 6px;
    background: #ddd;
    border-radius: 3px;
    cursor: pointer;
    position: relative;
  }
  #progress-filled {
    height: 100%;
    background: #007aff;
    width: 0%;
    border-radius: 3px;
  }
  #time-current, #time-duration {
    font-size: 12px;
    width: 40px;
    color: #555;
    user-select:none;
  }
  #volume-control {
    width: 120px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  #volume-control input[type="range"] {
    width: 100px;
  }

  /* Scrollbar */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-thumb {
    background: #ccc;
    border-radius: 4px;
  }
  ::-webkit-scrollbar-track {
    background: #f7f7f7;
  }
</style>
</head>
<body>
  <!-- Top Menu -->
  <nav id="top-menu" role="menubar" aria-label="Application menu">
    <ul>
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" role="menuitem" aria-controls="menu-file">File
        <ul id="menu-file" role="menu" aria-label="File menu">
          <li role="menuitem" tabindex="-1" id="file-open">Open File...</li>
          <li role="menuitem" tabindex="-1" id="file-exit">Exit</li>
        </ul>
      </li>
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" role="menuitem" aria-controls="menu-edit">Edit
        <ul id="menu-edit" role="menu" aria-label="Edit menu">
          <li role="menuitem" tabindex="-1" id="edit-undo">Undo</li>
          <li role="menuitem" tabindex="-1" id="edit-redo">Redo</li>
          <li role="separator" role="separator"></li>
          <li role="menuitem" tabindex="-1" id="edit-cut">Cut</li>
          <li role="menuitem" tabindex="-1" id="edit-copy">Copy</li>
          <li role="menuitem" tabindex="-1" id="edit-paste">Paste</li>
        </ul>
      </li>
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" role="menuitem" aria-controls="menu-view">View
        <ul id="menu-view" role="menu" aria-label="View menu">
          <li role="menuitem" tabindex="-1" id="view-library">Library</li>
          <li role="menuitem" tabindex="-1" id="view-playlists">Playlists</li>
          <li role="menuitem" tabindex="-1" id="view-albums">Albums</li>
          <li role="menuitem" tabindex="-1" id="view-artists">Artists</li>
        </ul>
      </li>
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" role="menuitem" aria-controls="menu-controls">Controls
        <ul id="menu-controls" role="menu" aria-label="Controls menu">
          <li role="menuitem" tabindex="-1" id="control-playpause">Play/Pause</li>
          <li role="menuitem" tabindex="-1" id="control-next">Next Track</li>
          <li role="menuitem" tabindex="-1" id="control-prev">Previous Track</li>
          <li role="menuitem" tabindex="-1" id="control-shuffle">Shuffle</li>
          <li role="menuitem" tabindex="-1" id="control-repeat">Repeat</li>
        </ul>
      </li>
      <li tabindex="0" aria-haspopup="true" aria-expanded="false" role="menuitem" aria-controls="menu-help">Help
        <ul id="menu-help" role="menu" aria-label="Help menu">
          <li role="menuitem" tabindex="-1" id="help-about">About iTunes Web Clone</li>
        </ul>
      </li>
    </ul>
  </nav>

  <!-- Main -->
  <div id="main" role="main">
    <!-- Sidebar -->
    <aside id="sidebar" role="navigation" aria-label="Sidebar navigation">
      <h2>Library</h2>
      <ul id="library-list" role="list">
        <li tabindex="0" class="active" data-section="library">Songs</li>
        <li tabindex="0" data-section="playlists">Playlists</li>
        <li tabindex="0" data-section="albums">Albums</li>
        <li tabindex="0" data-section="artists">Artists</li>
      </ul>
      <h2>Store</h2>
      <ul role="list">
        <li tabindex="0" class="disabled" aria-disabled="true">iTunes Store</li>
      </ul>
    </aside>

    <!-- Content -->
    <section id="content">
      <!-- Toolbar -->
      <div id="toolbar" role="region" aria-label="Search and sorting toolbar">
        <input type="text" id="search" placeholder="Search" aria-label="Search tracks" />
        <select id="sort-select" aria-label="Sort tracks">
          <option value="title">Title</option>
          <option value="artist">Artist</option>
          <option value="album">Album</option>
          <option value="duration">Time</option>
          <option value="genre">Genre</option>
        </select>
        <button id="new-playlist-btn" aria-label="Create new playlist">New Playlist</button>
      </div>

      <!-- Track list -->
      <div id="tracklist-container" role="region" aria-label="Track list">
        <table id="tracklist" role="grid" aria-readonly="true" aria-label="Music tracks">
          <thead>
            <tr>
              <th role="columnheader" data-sort="title" tabindex="0">Title</th>
              <th role="columnheader" data-sort="artist" tabindex="0">Artist</th>
              <th role="columnheader" data-sort="album" tabindex="0">Album</th>
              <th role="columnheader" data-sort="duration" tabindex="0">Time</th>
              <th role="columnheader" data-sort="genre" tabindex="0">Genre</th>
            </tr>
          </thead>
          <tbody id="tracklist-body" role="rowgroup"></tbody>
        </table>
      </div>

      <!-- Now Playing Bar -->
      <footer id="now-playing-bar" role="contentinfo" aria-label="Now playing controls">
        <div id="now-playing-info" aria-live="polite" aria-atomic="true">
          <span class="title" id="np-title">Not Playing</span> ‚Äî <span id="np-artist">---</span>
        </div>
        <div id="now-playing-controls">
          <button id="btn-prev" aria-label="Previous track" title="Previous track">‚èÆÔ∏è</button>
          <button id="btn-playpause" aria-label="Play or pause" title="Play/Pause">‚ñ∂Ô∏è</button>
          <button id="btn-next" aria-label="Next track" title="Next track">‚è≠Ô∏è</button>
          <button id="btn-shuffle" aria-label="Toggle shuffle" title="Shuffle">üîÄ</button>
          <button id="btn-repeat" aria-label="Toggle repeat" title="Repeat">üîÅ</button>
        </div>
        <div id="progress-container" aria-label="Playback progress">
          <span id="time-current">0:00</span>
          <div id="progress-bar" role="slider" tabindex="0" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div id="progress-filled"></div>
          </div>
          <span id="time-duration">0:00</span>
        </div>
        <div id="volume-control" aria-label="Volume control">
          <input type="range" id="volume-slider" min="0" max="1" step="0.01" aria-valuemin="0" aria-valuemax="1" aria-valuenow="1" />
        </div>
      </footer>
    </section>
  </div>

<script>
(() => {
  "use strict";

  // Google Drive API Key and Folder ID
  const API_KEY = "AIzaSyDsYE91wH7UDwu8eZNbD1CFuVcilgYeZhI";
  const FOLDER_ID = "1DGz9zEQh29EAqTZpmWK5mwSj5HComnkn";

  // Global State
  let tracks = [];
  let filteredTracks = [];
  let currentTrackIndex = -1;
  let isPlaying = false;
  let shuffle = false;
  let repeat = false;
  let playlists = {};
  let currentView = "library"; // library, playlists, albums, artists
  let currentSort = "title";

  // Elements
  const searchInput = document.getElementById("search");
  const sortSelect = document.getElementById("sort-select");
  const tracklistBody = document.getElementById("tracklist-body");
  const npTitle = document.getElementById("np-title");
  const npArtist = document.getElementById("np-artist");
  const btnPlayPause = document.getElementById("btn-playpause");
  const btnPrev = document.getElementById("btn-prev");
  const btnNext = document.getElementById("btn-next");
  const btnShuffle = document.getElementById("btn-shuffle");
  const btnRepeat = document.getElementById("btn-repeat");
  const progressBar = document.getElementById("progress-bar");
  const progressFilled = document.getElementById("progress-filled");
  const timeCurrent = document.getElementById("time-current");
  const timeDuration = document.getElementById("time-duration");
  const volumeSlider = document.getElementById("volume-slider");
  const newPlaylistBtn = document.getElementById("new-playlist-btn");
  const libraryList = document.getElementById("library-list");

  // Audio element and context for EQ
  const audio = new Audio();
  audio.crossOrigin = "anonymous";

  // EQ setup (6 bands)
  const AudioContext = window.AudioContext || window.webkitAudioContext;
  const audioCtx = new AudioContext();
  const sourceNode = audioCtx.createMediaElementSource(audio);

  const eqFrequencies = [60, 170, 350, 1000, 3500, 10000];
  const eqFilters = eqFrequencies.map(freq => {
    const filter = audioCtx.createBiquadFilter();
    filter.type = "peaking";
    filter.frequency.value = freq;
    filter.Q.value = 1;
    filter.gain.value = 0;
    return filter;
  });

  // Connect EQ chain
  sourceNode.connect(eqFilters[0]);
  for(let i = 0; i < eqFilters.length - 1; i++) {
    eqFilters[i].connect(eqFilters[i + 1]);
  }
  eqFilters[eqFilters.length - 1].connect(audioCtx.destination);

  // Helpers
  function formatTime(seconds) {
    const m = Math.floor(seconds / 60) || 0;
    const s = Math.floor(seconds % 60) || 0;
    return `${m}:${s < 10 ? "0" : ""}${s}`;
  }

  // Load tracks from Google Drive API
  async function loadTracks() {
    // Fetch list of mp3/m4a files in folder
    const files = [];
    let pageToken = "";
    do {
      const url = new URL("https://www.googleapis.com/drive/v3/files");
      url.searchParams.set("q", `'${FOLDER_ID}' in parents and (mimeType contains 'audio/mpeg' or mimeType contains 'audio/x-m4a' or mimeType contains 'audio/wav') and trashed=false`);
      url.searchParams.set("key", API_KEY);
      url.searchParams.set("fields", "nextPageToken, files(id, name, mimeType, size)");
      url.searchParams.set("pageSize", "1000");
      if(pageToken) url.searchParams.set("pageToken", pageToken);

      const response = await fetch(url.toString());
      if(!response.ok) throw new Error("Failed to load files from Google Drive API");
      const data = await response.json();
      files.push(...data.files);
      pageToken = data.nextPageToken || "";
    } while(pageToken);

    // Map files to tracks, parse title & artist from filename (Format: Artist - Title.mp3)
    tracks = files.map(f => {
      let name = f.name.replace(/\.[^/.]+$/, ""); // Remove extension
      let artist = "Unknown Artist";
      let title = name;
      if(name.includes(" - ")) {
        const parts = name.split(" - ");
        artist = parts[0];
        title = parts.slice(1).join(" - ");
      }
      return {
        id: f.id,
        title,
        artist,
        album: "Unknown Album",
        genre: "Unknown",
        duration: 0,
        url: `https://www.googleapis.com/drive/v3/files/${f.id}?alt=media&key=${API_KEY}`
      };
    });

    filteredTracks = [...tracks];
    sortTracks(currentSort);
    renderTrackList();
  }

  // Render tracks in table
  function renderTrackList() {
    tracklistBody.innerHTML = "";
    filteredTracks.forEach((track, i) => {
      const tr = document.createElement("tr");
      tr.tabIndex = 0;
      tr.dataset.index = i;
      if(i === currentTrackIndex) tr.classList.add("playing");
      tr.innerHTML = `
        <td>${track.title}</td>
        <td>${track.artist}</td>
        <td>${track.album}</td>
        <td>${formatTime(track.duration)}</td>
        <td>${track.genre}</td>
      `;
      tr.addEventListener("click", () => {
        playTrack(i);
      });
      tr.addEventListener("keydown", e => {
        if(e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          playTrack(i);
        }
      });
      tracklistBody.appendChild(tr);
    });
  }

  // Play a track by index
  async function playTrack(index) {
    if(index < 0 || index >= filteredTracks.length) return;
    const track = filteredTracks[index];
    currentTrackIndex = index;

    if(audioCtx.state === "suspended") await audioCtx.resume();

    audio.src = track.url;
    audio.load();

    npTitle.textContent = track.title;
    npArtist.textContent = track.artist;

    // Play
    try {
      await audio.play();
      isPlaying = true;
      updatePlayPauseBtn();
      updatePlayingRow();
    } catch(e) {
      console.warn("Playback interrupted:", e);
    }
  }

  // Update play/pause button icon
  function updatePlayPauseBtn() {
    btnPlayPause.textContent = isPlaying ? "‚è∏Ô∏è" : "‚ñ∂Ô∏è";
  }

  // Update currently playing row highlight
  function updatePlayingRow() {
    Array.from(tracklistBody.children).forEach((tr, i) => {
      tr.classList.toggle("playing", i === currentTrackIndex);
    });
  }

  // Toggle play/pause
  async function togglePlayPause() {
    if(!audio.src) {
      if(filteredTracks.length) playTrack(0);
      return;
    }
    if(isPlaying) {
      audio.pause();
      isPlaying = false;
    } else {
      try {
        await audio.play();
        isPlaying = true;
      } catch(e) {
        console.warn("Playback interrupted:", e);
      }
    }
    updatePlayPauseBtn();
  }

  // Play next track
  function playNext() {
    if(shuffle) {
      let next = Math.floor(Math.random() * filteredTracks.length);
      if(next === currentTrackIndex) next = (next + 1) % filteredTracks.length;
      playTrack(next);
    } else {
      let next = currentTrackIndex + 1;
      if(next >= filteredTracks.length) next = 0;
      playTrack(next);
    }
  }

  // Play previous track
  function playPrev() {
    if(shuffle) {
      let prev = Math.floor(Math.random() * filteredTracks.length);
      if(prev === currentTrackIndex) prev = (prev + 1) % filteredTracks.length;
      playTrack(prev);
    } else {
      let prev = currentTrackIndex - 1;
      if(prev < 0) prev = filteredTracks.length - 1;
      playTrack(prev);
    }
  }

  // Shuffle toggle
  btnShuffle.addEventListener("click", () => {
    shuffle = !shuffle;
    btnShuffle.style.color = shuffle ? "#007aff" : "#333";
  });

  // Repeat toggle
  btnRepeat.addEventListener("click", () => {
    repeat = !repeat;
    btnRepeat.style.color = repeat ? "#007aff" : "#333";
  });

  // Audio event listeners
  audio.addEventListener("ended", () => {
    if(repeat) {
      playTrack(currentTrackIndex);
    } else {
      playNext();
    }
  });

  audio.addEventListener("timeupdate", () => {
    if(audio.duration) {
      const percent = (audio.currentTime / audio.duration) * 100;
      progressFilled.style.width = percent + "%";
      progressBar.setAttribute("aria-valuenow", Math.floor(percent));
      timeCurrent.textContent = formatTime(audio.currentTime);
      timeDuration.textContent = formatTime(audio.duration);
    }
  });

  // Progress bar seeking
  progressBar.addEventListener("click", e => {
    const rect = progressBar.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const pct = clickX / rect.width;
    if(audio.duration) {
      audio.currentTime = pct * audio.duration;
    }
  });
  // Keyboard controls for progress bar
  progressBar.addEventListener("keydown", e => {
    if(!audio.duration) return;
    if(e.key === "ArrowLeft") {
      audio.currentTime = Math.max(0, audio.currentTime - 5);
    } else if(e.key === "ArrowRight") {
      audio.currentTime = Math.min(audio.duration, audio.currentTime + 5);
    }
  });

  // Volume control
  volumeSlider.addEventListener("input", () => {
    audio.volume = volumeSlider.value;
  });
  // Initialize volume
  audio.volume = volumeSlider.value;

  // Playback control buttons
  btnPlayPause.addEventListener("click", togglePlayPause);
  btnNext.addEventListener("click", playNext);
  btnPrev.addEventListener("click", playPrev);

  // Search tracks
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.trim().toLowerCase();
    if(!q) {
      filteredTracks = [...tracks];
    } else {
      filteredTracks = tracks.filter(t =>
        t.title.toLowerCase().includes(q) ||
        t.artist.toLowerCase().includes(q) ||
        t.album.toLowerCase().includes(q) ||
        t.genre.toLowerCase().includes(q)
      );
    }
    sortTracks(currentSort);
    renderTrackList();
  });

  // Sort tracks
  sortSelect.addEventListener("change", e => {
    currentSort = e.target.value;
    sortTracks(currentSort);
    renderTrackList();
  });

  function sortTracks(by) {
    filteredTracks.sort((a, b) => {
      if(by === "duration") return (a.duration || 0) - (b.duration || 0);
      const va = (a[by] || "").toLowerCase();
      const vb = (b[by] || "").toLowerCase();
      if(va < vb) return -1;
      if(va > vb) return 1;
      return 0;
    });
  }

  // Sidebar navigation click
  libraryList.querySelectorAll("li").forEach(li => {
    li.addEventListener("click", () => {
      libraryList.querySelectorAll("li").forEach(x => x.classList.remove("active"));
      li.classList.add("active");
      currentView = li.dataset.section;
      // TODO: For demo, only implement "library" showing all songs
      if(currentView === "library") {
        filteredTracks = [...tracks];
        sortTracks(currentSort);
        renderTrackList();
      } else {
        // For playlists/albums/artists views show placeholder
        tracklistBody.innerHTML = `<tr><td colspan="5" style="padding:16px; color:#999;">View "${currentView}" is not implemented in this demo.</td></tr>`;
      }
    });
  });

  // New Playlist button - dummy alert for now
  newPlaylistBtn.addEventListener("click", () => {
    alert("Playlist feature coming soon!");
  });

  // Keyboard shortcuts for menu (basic)
  document.getElementById("menu-controls").querySelectorAll("li").forEach(item => {
    item.addEventListener("click", () => {
      switch(item.id) {
        case "control-playpause": togglePlayPause(); break;
        case "control-next": playNext(); break;
        case "control-prev": playPrev(); break;
        case "control-shuffle": btnShuffle.click(); break;
        case "control-repeat": btnRepeat.click(); break;
      }
    });
  });

  // Initial load
  loadTracks().catch(e => {
    alert("Failed to load music tracks. Check console for details.");
    console.error(e);
  });

})();
</script>
</body>
</html>
