<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>iTunes — Full Clone with Google Drive & Smart Playlists</title>
<meta name="description" content="iTunes-like web player that streams from Google Drive, includes Smart Playlists, dark mode, shuffle, repeat, detachable mini-player."/>
<!--
  Single-file app:
  - Uses the provided Google Drive API key and folder ID to list files and stream them via alt=media.
  - Smart Playlist builder: add multiple rules and save playlists locally.
  - Mini-player (draggable & detachable with postMessage).
  - Highly defensive to avoid runtime errors.
  - NOTE: For private Drive folders, you MUST use OAuth2. This uses API Key and works for publicly shared files.
-->
<style>
  /* Apple-music / iTunes-inspired desktop look (not pixel-perfect but close) */
  :root{
    --bg:#f5f7fb; --panel:#ffffff; --muted:#6b7280; --text:#0f1724; --accent:#1e90ff; --shadow:0 6px 18px rgba(11,22,33,0.08);
  }
  [data-theme="dark"]{
    --bg:#0b0b0d; --panel:rgba(20,20,24,0.9); --muted:#9aa7bb; --text:#e6eef8; --accent:#ff2d55; --shadow:0 10px 30px rgba(0,0,0,0.6);
  }
  html,body{height:100%; margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial; background:linear-gradient(180deg,var(--bg),#e9eef6); color:var(--text);}
  .app{ display:grid; grid-template-columns: 260px 1fr 360px; gap:20px; padding:22px; height:100vh; box-sizing:border-box;}
  /* sidebar */
  .sidebar{ background:linear-gradient(180deg,var(--panel),#f7fbff); border-radius:12px; padding:18px; box-shadow:var(--shadow); overflow:auto; display:flex;flex-direction:column;}
  .brand{font-weight:900; font-size:18px; display:flex; align-items:center; gap:10px; margin-bottom:12px}
  .controls{display:flex; gap:8px; margin-bottom:12px}
  .btn{ padding:8px 12px; border-radius:10px; border:none; background:var(--accent); color:white; cursor:pointer; font-weight:700 }
  .btn.ghost{ background:transparent; color:var(--text); border:1px solid rgba(0,0,0,0.06) }
  .nav{ display:flex; flex-direction:column; gap:6px; margin-top:12px }
  .nav button{ background:transparent; color:var(--text); border:none; text-align:left; padding:8px; border-radius:8px; cursor:pointer }
  .muted{ color:var(--muted); font-size:13px }

  /* main */
  .header{ display:flex; align-items:center; gap:12px; margin-bottom:12px }
  .search{ flex:1; display:flex; gap:8px; }
  .search input{ width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.06); background:var(--panel) }
  .library{ background:linear-gradient(180deg,var(--panel),#ffffff); border-radius:12px; padding:14px; box-shadow:var(--shadow); height:calc(100vh - 140px); overflow:auto }
  .list-table{ width:100%; border-collapse:collapse; }
  .list-table th, .list-table td{ padding:10px 12px; text-align:left; border-bottom:1px solid rgba(0,0,0,0.04); font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .list-table thead th{ font-weight:800; font-size:13px; background:linear-gradient(180deg,#fbfdff,#f1f5ff) }
  .row:hover{ background:rgba(0,0,0,0.02); cursor:pointer }

  /* right pane - now playing + smart playlists */
  .right{ padding:18px; border-radius:12px; background:linear-gradient(180deg,var(--panel),#fbfdff); box-shadow:var(--shadow); overflow:auto; display:flex; flex-direction:column; gap:12px; height:calc(100vh - 44px) }
  .nowplaying-card{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; background:rgba(255,255,255,0.5) }
  .art{ width:84px; height:84px; border-radius:8px; background:linear-gradient(135deg,#cfd8e3,#b5c0d8); display:flex; align-items:center; justify-content:center; font-weight:800; color:var(--muted) }
  .np-controls{ display:flex; gap:8px; align-items:center; margin-top:6px }

  /* status bar */
  .playback{ grid-column:1 / -1; position:fixed; left:260px; right:360px; bottom:22px; height:84px; background:var(--panel); border-radius:12px; display:flex; align-items:center; gap:12px; padding:12px 16px; box-shadow:var(--shadow) ; z-index:999}
  .progress{ flex:1; height:8px; background:rgba(0,0,0,0.06); border-radius:8px; position:relative; overflow:hidden }
  .progress .fill{ height:100%; background:linear-gradient(90deg,var(--accent),#7ac7ff); width:0% }

  /* mini-player draggable (in-page) */
  .mini{ position:fixed; right:28px; bottom:130px; background:var(--panel); border-radius:12px; padding:8px; box-shadow:var(--shadow); display:flex; gap:8px; align-items:center; width:320px; z-index:1000; cursor:grab }
  .mini .art{ width:56px; height:56px }

  /* Smart playlist builder */
  .smart-builder{ display:flex; flex-direction:column; gap:8px }
  .rule{ display:flex; gap:8px; align-items:center }
  .rule select, .rule input{ padding:8px; border-radius:8px; border:1px solid rgba(0,0,0,0.06) }

  /* responsive tweaks */
  @media (max-width:1200px){ .app{ grid-template-columns: 200px 1fr; } .playback{ left:200px; right:20px } .right{ display:none } }
  @media (max-width:900px){ .sidebar{ display:none } .app{ grid-template-columns: 1fr } .playback{ left:20px; right:20px } .mini{ display:none } }
</style>
</head>
<body data-theme="">

<div class="app" id="appRoot">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand"> iTunes Clone</div>

    <div class="controls">
      <button id="importLocal" class="btn ghost">Import Files</button>
      <button id="saveLibrary" class="btn">Save</button>
    </div>

    <div style="margin-bottom:8px">
      <label class="muted">Google API Key</label>
      <input id="apiInput" placeholder="API Key" style="width:100%;padding:8px;border-radius:8px;margin-top:6px" />
      <label class="muted" style="margin-top:8px">Drive Folder ID</label>
      <input id="folderInput" placeholder="Folder ID" style="width:100%;padding:8px;border-radius:8px;margin-top:6px" />
      <div style="display:flex; gap:8px; margin-top:8px">
        <button id="loadDrive" class="btn">Load Drive</button>
        <button id="loadSample" class="btn ghost">Load Sample</button>
      </div>
    </div>

    <nav class="nav">
      <button id="viewLibrary">Library</button>
      <button id="viewSmart">Smart Playlists</button>
      <button id="toggleTheme" class="btn ghost">Toggle Dark</button>
    </nav>

    <div style="margin-top:auto">
      <div class="mut
